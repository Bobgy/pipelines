# Cloudbuild pipeline to verify some images pass the vulnerability policy
# Requirement: https://cloud.google.com/binary-authorization/docs/creating-attestations-kritis#set_up_the_kritis_signer_custom_builder
steps:
- name: gcr.io/cloud-builders/docker
  entrypoint: /bin/bash
  args:
  - -c
  - |
    set -ex

    version="c484cfa46cfae1e9d11b5d00e0799b8e52c15e33" # 1.3.0
    IMAGES=(
      api-server
      persistenceagent
      scheduledworkflow
      frontend
      viewer-crd-controller
      visualization-server
      inverse-proxy-agent
      metadata-writer
      cache-server
      cache-deployer
      metadata-envoy
    )
    upstream_repo=gcr.io/$PROJECT_ID
    for image in "${IMAGES[@]}"
    do
      image_full="$upstream_repo/$image:$version"
      docker pull $image_full
      docker image inspect $image_full --format '{{index .RepoDigests 0}}' \
        >> /workspace/images
    done
    cat /workspace/images
- name: gcr.io/$PROJECT_ID/kritis-signer
  entrypoint: /bin/bash
  args:
  - -c
  - |
    set -ex

    for image in $(/bin/cat /workspace/images)
    do
      /kritis/signer \
      -v=10 \
      -alsologtostderr \
      -image="${image}" \
      -policy=vulnz_policy.yaml \
      -mode=check-only
    done
